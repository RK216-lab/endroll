<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚¨ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ«ä½œæˆ</title>
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.2/dist/ffmpeg.min.js"></script>
<style>
body {
  margin:0;
  padding:20px;
  background:#111;
  color:white;
  font-family:"ï¼­ï¼³ æ˜æœ","MS Mincho",serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:20px;
}

/* â”€ UIã‚’ãƒŸãƒ‹ãƒãƒ«ã« â”€ */
h2 { margin:0; font-size:26px; }

label, input[type="text"], button {
  width:350px;
  background:#222;
  padding:10px;
  border-radius:6px;
  border:none;
  color:white;
  font-size:16px;
}
label { cursor:pointer; }
input[type="file"] { margin-top:6px; }

button {
  background:#444;
  cursor:pointer;
  transition:0.2s;
}
button:hover { background:#666; }

#çŸ¢å°æ“ä½œ {
  display:flex;
  align-items:center;
  gap:15px;
}
#ç¾åœ¨ã®å†™çœŸè¡¨ç¤º {
  width:320px;
  height:320px;
  object-fit:contain;
  border:1px solid #555;
}

canvas {
  background:black;
  width:800px; height:450px;
  border:2px solid #333;
}
</style>
</head>
<body>

<h2>ã‚¨ãƒ³ãƒ‰ãƒ­ãƒ¼ãƒ«ä½œæˆ</h2>

<label>ç”»åƒã‚’é¸æŠ
  <input type="file" id="ç”»åƒé¸æŠ" multiple accept="image/*">
</label>

<input type="text" id="æœ€åˆã®ã‚¿ã‚¤ãƒˆãƒ«" placeholder="æœ€åˆã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç”»åƒãªã—ï¼‰">
<input type="text" id="æœ€å¾Œã®ã‚¿ã‚¤ãƒˆãƒ«" placeholder="æœ€å¾Œã®ã‚¿ã‚¤ãƒˆãƒ«">

<div id="çŸ¢å°æ“ä½œ">
  <button id="å‰ã¸">â¬…ï¸</button>
  <img id="ç¾åœ¨ã®å†™çœŸè¡¨ç¤º">
  <button id="æ¬¡ã¸">â¡ï¸</button>
</div>

<input type="text" id="æ™‚æœŸ" placeholder="æ™‚æœŸï¼ˆå¹´ãªã©ï¼‰">
<input type="text" id="åå‰" placeholder="å‡ºæ¥äº‹ãƒ»åå‰ãªã©">

<button id="å‹•ç”»ä½œæˆ">å‹•ç”»ä½œæˆğŸ¬</button>

<canvas id="canvas" width="800" height="450"></canvas>
<video id="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‹•ç”»" controls></video>

<script>
const ç”»åƒé¸æŠ = document.getElementById('ç”»åƒé¸æŠ');
const ç¾åœ¨ã®å†™çœŸè¡¨ç¤º = document.getElementById('ç¾åœ¨ã®å†™çœŸè¡¨ç¤º');
const æ™‚æœŸå…¥åŠ› = document.getElementById('æ™‚æœŸ');
const åå‰å…¥åŠ› = document.getElementById('åå‰');
const å‰ã¸ãƒœã‚¿ãƒ³ = document.getElementById('å‰ã¸');
const æ¬¡ã¸ãƒœã‚¿ãƒ³ = document.getElementById('æ¬¡ã¸');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‹•ç”» = document.getElementById('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‹•ç”»');
const æœ€åˆã®ã‚¿ã‚¤ãƒˆãƒ« = document.getElementById('æœ€åˆã®ã‚¿ã‚¤ãƒˆãƒ«');
const æœ€å¾Œã®ã‚¿ã‚¤ãƒˆãƒ« = document.getElementById('æœ€å¾Œã®ã‚¿ã‚¤ãƒˆãƒ«');
const å‹•ç”»ä½œæˆãƒœã‚¿ãƒ³ = document.getElementById('å‹•ç”»ä½œæˆ');

let å†™çœŸãƒªã‚¹ãƒˆ = [];
let ç¾åœ¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ = 0;

/* ç”»åƒèª­ã¿è¾¼ã¿ */
ç”»åƒé¸æŠ.addEventListener('change', e=>{
  å†™çœŸãƒªã‚¹ãƒˆ = [];
  ç¾åœ¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ = 0;
  const files = Array.from(e.target.files);

  files.forEach(file=>{
    if(!file.type.startsWith("image")) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      const img = new Image();
      img.onload = ()=> {
        // æ™‚æœŸãƒ»åå‰ã¯å¾Œã§å…¥åŠ›ã™ã‚‹å‰æã€‚æœªå…¥åŠ›ã ã¨ç©ºæ–‡å­—ã«ãªã‚‹ãŒã€ä¿å­˜ãƒŸã‚¹ã‚’é˜²ããŸã‚inputä¿å­˜ã‚’å¿…ãšè¡Œã†ã‚ˆã†ã«ã™ã‚‹ã€‚
        å†™çœŸãƒªã‚¹ãƒˆ.push({img,æ™‚æœŸ:"",åå‰:""});
        if(å†™çœŸãƒªã‚¹ãƒˆ.length===1) æ›´æ–°();
      }
      img.src = ev.target.result;
    }
    reader.readAsDataURL(file);
  });
});

/* è¡¨ç¤ºæ›´æ–° */
function æ›´æ–°(){
  if(å†™çœŸãƒªã‚¹ãƒˆ.length===0){
    ç¾åœ¨ã®å†™çœŸè¡¨ç¤º.src = "";
    æ™‚æœŸå…¥åŠ›.value = "";
    åå‰å…¥åŠ›.value = "";
    return;
  }
  const d = å†™çœŸãƒªã‚¹ãƒˆ[ç¾åœ¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹];
  ç¾åœ¨ã®å†™çœŸè¡¨ç¤º.src = d.img.src;
  æ™‚æœŸå…¥åŠ›.value = d.æ™‚æœŸ;
  åå‰å…¥åŠ›.value = d.åå‰;
}

/* å…¥åŠ›ä¿å­˜ */
function ä¿å­˜(){
  if(å†™çœŸãƒªã‚¹ãƒˆ.length===0) return;
  // ç©ºæ¬„ã§ã‚‚å¿…ãšä¿å­˜ï¼ˆæœªä¿å­˜ã§ç”Ÿæˆã™ã‚‹ã¨1æšç›®ã ã‘ã«ãªã‚‹åŸå› ã®å¤šãã¯ã“ã“ï¼‰
  å†™çœŸãƒªã‚¹ãƒˆ[ç¾åœ¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹].æ™‚æœŸ = æ™‚æœŸå…¥åŠ›.value || "";
  å†™çœŸãƒªã‚¹ãƒˆ[ç¾åœ¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹].åå‰ = åå‰å…¥åŠ›.value || "";
}

/* çŸ¢å°æ“ä½œ */
å‰ã¸ãƒœã‚¿ãƒ³.onclick = ()=>{
  ä¿å­˜();
  if(å†™çœŸãƒªã‚¹ãƒˆ.length===0) return;
  ç¾åœ¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ = (ç¾åœ¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ -1 + å†™çœŸãƒªã‚¹ãƒˆ.length) % å†™çœŸãƒªã‚¹ãƒˆ.length;
  æ›´æ–°();
}
æ¬¡ã¸ãƒœã‚¿ãƒ³.onclick = ()=>{
  ä¿å­˜();
  if(å†™çœŸãƒªã‚¹ãƒˆ.length===0) return;
  ç¾åœ¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ = (ç¾åœ¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ +1) % å†™çœŸãƒªã‚¹ãƒˆ.length;
  æ›´æ–°();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ã€€ã€€ å‹•ç”»ç”Ÿæˆ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
å‹•ç”»ä½œæˆãƒœã‚¿ãƒ³.onclick = async()=>{

  if(å†™çœŸãƒªã‚¹ãƒˆ.length===0){
    alert("å†™çœŸãŒãªã„ã‚ˆã€œï¼");
    return;
  }

  // ç”Ÿæˆå‰ã«ä»Šè¦‹ã¦ã„ã‚‹å…¥åŠ›ã‚’ä¿å­˜ï¼ˆã“ã‚ŒãŒãªã„ã¨æœ€æ–°ç·¨é›†ãŒåæ˜ ã•ã‚Œãªã„ï¼‰
  ä¿å­˜();

  const stream = canvas.captureStream();
  const chunks = [];
  const rec = new MediaRecorder(stream,{mimeType:"video/webm; codecs=vp9"});
  rec.ondataavailable = e=>{ if(e.data.size>0) chunks.push(e.data); };
  rec.onstop = async ()=>{
  const blob = new Blob(chunks,{type:"video/webm"});

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  const url = URL.createObjectURL(blob);
  ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‹•ç”».src = url;
  ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‹•ç”».play();

  // ã™ã§ã«å‰ã®ãƒªãƒ³ã‚¯ãŒã‚ã‚Œã°æ¶ˆã™
  const old = document.getElementById("downloadLink");
  if(old) old.remove();

  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ç”Ÿæˆï¼ˆwebmï¼‰
  const a = document.createElement("a");
  a.id = "downloadLink";
  a.href = url;
  a.download = "endroll.webm";
  a.textContent = "â–¶ å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆä¿å­˜ï¼‰";
  a.style.display = "block";
  a.style.marginTop = "10px";
  a.style.color = "#4af";
  a.style.fontSize = "20px";
  document.body.appendChild(a);

  /* â˜… ã“ã“ã‚’è¿½åŠ ï¼ï¼ï¼ .mp4 ã‚’è‡ªå‹•ã§å¤‰æ›ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â˜… */
  downloadMp4(blob);
};
  rec.start();

  const fps = 30;
  const ã‚¿ã‚¤ãƒˆãƒ«ç§’ = 5;
  const å†™çœŸç§’ = 8;

  const wait = ()=> new Promise(r=>setTimeout(r, 1000/fps));

  /* ç”»åƒã‚’å¼•ãä¼¸ã°ã•ãš contain ã§å·¦åŠåˆ†ã«é…ç½® */
  function drawContain(img){
    const frameW = canvas.width/2;
    const frameH = canvas.height;
    const scale = Math.min(frameW / img.width, frameH / img.height);
    const w = img.width * scale;
    const h = img.height * scale;
    const x = 0;
    const y = (canvas.height - h)/2;
    ctx.drawImage(img, x, y, w, h);
  }

  /* ãƒ•ã‚§ãƒ¼ãƒ‰ç”¨ï¼ˆç”»åƒã®ã¿ã«ä½¿ã†ï¼‰ */
  function drawImageWithFade(img, alpha){
    ctx.save();
    ctx.globalAlpha = alpha;
    drawContain(img);
    ctx.restore();
  }

  /* â”€ æœ€åˆã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç”»åƒãªã—ï¼‰ â”€ */
  for(let f=0; f<fps*ã‚¿ã‚¤ãƒˆãƒ«ç§’; f++){
    ctx.fillStyle="black";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    let alpha = (f<fps) ? f/fps : (f>fps*ã‚¿ã‚¤ãƒˆãƒ«ç§’-fps ? (fps*ã‚¿ã‚¤ãƒˆãƒ«ç§’ - f)/fps : 1);

    ctx.fillStyle="white";
    ctx.font='48px "ï¼­ï¼³ æ˜æœ"';
    ctx.fillText(
      æœ€åˆã®ã‚¿ã‚¤ãƒˆãƒ«.value || "",
      canvas.width/2 - ctx.measureText(æœ€åˆã®ã‚¿ã‚¤ãƒˆãƒ«.value || "").width/2,
      canvas.height/2
    );

    await wait();
  }

  /* â”€ å„å†™çœŸãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆ + å®Œå…¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾Œã«åˆ‡ã‚Šæ›¿ãˆ â”€ */
  for (const item of å†™çœŸãƒªã‚¹ãƒˆ) {

    // å„ãƒ•ãƒ¬ãƒ¼ãƒ ã®æ•°
    const totalFrames = å†™çœŸç§’ * fps;

    // ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–‹å§‹/çµ‚äº†ä½ç½®ï¼ˆä¸‹â†’ä¸Šï¼‰
    const scrollStart = canvas.height + 100;
    const scrollEnd = -150;

    for (let f = 0; f < totalFrames; f++) {
      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆ for image */
      let alpha = 1;
      if (f < fps) alpha = f / fps;                                  // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼ˆ1ç§’ï¼‰
      if (f > totalFrames - fps) alpha = (totalFrames - f) / fps;     // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼ˆ1ç§’ï¼‰

      // ç”»åƒã ã‘ãƒ•ã‚§ãƒ¼ãƒ‰ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã¯ç‹¬ç«‹ã—ã¦è¡¨ç¤ºï¼‰
      drawImageWithFade(item.img, alpha);

      // ãƒ†ã‚­ã‚¹ãƒˆã¯å¸¸ã«ãƒ•ãƒ«ä¸é€æ˜ã§æç”»ï¼ˆèª­ã¿ã‚„ã™ã•å„ªå…ˆï¼‰
      ctx.fillStyle = "white";
      ctx.font = '30px "ï¼­ï¼³ æ˜æœ"';

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¸€å¾‹ã§è¨ˆç®—ï¼ˆå¿…ãšæœ€å¾Œã¾ã§è¡Œãï¼‰
      const t = f / totalFrames;
      const yText = scrollStart + (scrollEnd - scrollStart) * t;

      // å®‰å…¨ã®ãŸã‚ç©ºæ–‡å­—ã§ã‚‚æç”»ã—ã‚ˆã†ï¼ˆ1æšç›®ä»¥å¤–ãŒæœªå…¥åŠ›ãªã‚‰ã“ã“ã§""ãŒæã‹ã‚Œã‚‹ï¼‰
      ctx.fillText(item.æ™‚æœŸ || "", canvas.width / 2 + 40, yText);
      ctx.fillText(item.åå‰ || "", canvas.width / 2 + 40, yText + 40);

      await wait();
    }
  }

  /* â”€ æœ€å¾Œã®ã‚¿ã‚¤ãƒˆãƒ« + æ¨©åˆ©è¡¨è¨˜ â”€ */
  const rights = "Â©ï¸loyal corp. all rights reserved.";

  for(let f=0; f<fps*ã‚¿ã‚¤ãƒˆãƒ«ç§’; f++){
    ctx.fillStyle="black";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    let alpha = (f<fps) ? f/fps : (f>fps*ã‚¿ã‚¤ãƒˆãƒ«ç§’-fps ? (fps*ã‚¿ã‚¤ãƒˆãƒ«ç§’ - f)/fps : 1);

    ctx.fillStyle="white";
    ctx.font='48px "ï¼­ï¼³ æ˜æœ"';
    ctx.fillText(
      æœ€å¾Œã®ã‚¿ã‚¤ãƒˆãƒ«.value || "",
      canvas.width/2 - ctx.measureText(æœ€å¾Œã®ã‚¿ã‚¤ãƒˆãƒ«.value || "").width/2,
      canvas.height/2
    );

    ctx.font='28px "ï¼­ï¼³ æ˜æœ"';
    ctx.fillText(
      rights,
      canvas.width/2 - ctx.measureText(rights).width/2,
      canvas.height/2 + 60
    );

    // ãƒ­ã‚´ç”»åƒè¡¨ç¤º
const logo = new Image();
logo.src = "logo.png"; // ã‚Šã¿ãŒæ·»ä»˜ã—ãŸç”»åƒã®ãƒ‘ã‚¹

// ç”»åƒãŒèª­ã¿è¾¼ã¿æ¸ˆã¿ãªã‚‰æç”»
if (logo.complete) {
  const lw = 300;  // ãƒ­ã‚´ã®å¹…ï¼ˆèª¿æ•´OKï¼‰
  const lh = (logo.height / logo.width) * lw;
  ctx.drawImage(
    logo,
    canvas.width / 2 - lw / 2,
    canvas.height / 2 + 120, // è‘—ä½œæ¨©è¡¨è¨˜ã®ã•ã‚‰ã«ä¸‹
    lw,
    lh
  );
}

    await wait();
  }

  rec.stop();
};
async function convertWebmToMp4(webmBlob) {
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true }); // logã¯æ¶ˆã—ã¦ã‚‚OK
    await ffmpeg.load();

    ffmpeg.FS("writeFile", "input.webm", await fetchFile(webmBlob));
    await ffmpeg.run("-i", "input.webm", "output.mp4");

    const data = ffmpeg.FS("readFile", "output.mp4");
    return new Blob([data.buffer], { type: "video/mp4" });
}
async function downloadMp4(webmBlob) {
    const mp4Blob = await convertWebmToMp4(webmBlob);

    const url = URL.createObjectURL(mp4Blob);

    // ã™ã§ã«å‰ã® mp4 ãƒªãƒ³ã‚¯ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤
    const old = document.getElementById("mp4Link");
    if (old) old.remove();

    // mp4 ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
    const a = document.createElement("a");
    a.id = "mp4Link";
    a.href = url;
    a.download = "endroll.mp4";
    a.textContent = "â–¶ MP4ç‰ˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆé«˜ç”»è³ªï¼‰";
    a.style.display = "block";
    a.style.marginTop = "10px";
    a.style.color = "#fa4";
    a.style.fontSize = "20px";

    document.body.appendChild(a);
}
</script>
</body>
</html>
